<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Admin (Auto-Save & History)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* --- [ê¸°ë³¸ ìŠ¤íƒ€ì¼] --- */
        body { font-family: 'Pretendard', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        
        /* í—¤ë” ë° ì„¤ì • ì˜ì—­ */
        .sticky-header { position: sticky; top: 0; background: rgba(255,255,255,0.98); z-index: 1000; padding: 15px 0; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .config-panel { background: #eef2f5; padding: 15px; border-radius: 8px; font-size: 0.9rem; display: none; margin-bottom: 15px; }
        .config-panel.open { display: block; }
        .config-row { display: flex; gap: 10px; margin-bottom: 5px; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: #2c3e50; color: white; }
        .btn-primary:hover { background: #1a252f; }
        .btn-outline { border: 1px solid #ddd; background: white; color: #555; }
        .btn-danger { background: #ff6b6b; color: white; font-size: 0.8rem; padding: 5px 10px; }
        .btn-history { background: #007bff; color: white; }

        /* ì…ë ¥ í¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; color: #555; }
        input[type="text"], input[type="password"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box; }
        .preview-img { max-width: 150px; max-height: 150px; border: 1px solid #eee; margin-top: 10px; border-radius: 4px; }

        /* ê°¤ëŸ¬ë¦¬ & í•„ëª¨ê·¸ë˜í”¼ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .gallery-item { position: relative; aspect-ratio: 1/1; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .remove-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; }

        .category-section { margin-bottom: 30px; background: #f8f9fa; border-radius: 8px; padding: 20px; border: 1px solid #e9ecef; }
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .category-title { font-size: 1.2rem; font-weight: 800; color: #2c3e50; }
        .filmo-item { background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        .filmo-summary { display: flex; align-items: center; padding: 15px; cursor: pointer; }
        .filmo-summary:hover { background: #f1f3f5; }
        .filmo-details { display: none; padding: 20px; border-top: 1px solid #eee; background: #fafafa; }
        .filmo-item.active .filmo-details { display: block; }
        .thumb-preview { width: 40px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; background: #eee; }
        .info-preview { flex: 1; }
        
        .btn-add-section { width: 100%; padding: 12px; background-color: white; border: 2px dashed #cbd5e0; color: #4a5568; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 10px;}
        .empty-message { text-align: center; color: #888; padding: 20px; }
        
        .lang-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 500px; max-height: 80vh; border-radius: 12px; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .history-item:hover { background: #f9f9f9; }
        .history-info div { font-size: 0.9rem; font-weight: bold; }
        .history-info span { font-size: 0.8rem; color: #888; }
        
        /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; text-align: center; line-height: 100vh; font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
    </style>
</head>
<body>

    <div class="loading" id="loadingSpinner">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)</div>

    <div class="container">
        <div class="sticky-header">
            <div class="header-top">
                <h1>ADMIN PAGE (Auto-Save)</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="toggleConfig()">âš™ï¸ ì„¤ì •</button>
                    <button class="btn btn-history" onclick="loadHistory()">ğŸ•’ íˆìŠ¤í† ë¦¬/ë³µêµ¬</button>
                    <button class="btn btn-primary" onclick="saveToGitHub()">â˜ï¸ GitHub ìë™ ì €ì¥</button>
                </div>
            </div>
            
            <div id="configPanel" class="config-panel">
                <p style="margin:0 0 10px 0; font-weight:bold; color:#e74c3c;">â€» ìµœì´ˆ 1íšŒ ì„¤ì • í•„ìš” (GitHub ì •ë³´ ì…ë ¥)</p>
                <div class="config-row">
                    <input type="text" id="confOwner" placeholder="GitHub ì•„ì´ë”” (ì˜ˆ: seojoonkim)">
                    <input type="text" id="confRepo" placeholder="ë ˆí¬ì§€í† ë¦¬ ì´ë¦„ (ì˜ˆ: yeonjooha)">
                </div>
                <div class="config-row">
                    <input type="password" id="confToken" placeholder="GitHub Token (ghp_... ì‹œì‘í•˜ëŠ” ì½”ë“œ)">
                    <button class="btn btn-primary" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
                </div>
            </div>
        </div>

        <section>
            <h2>1. ë©”ì¸ í”„ë¡œí•„</h2>
            <div class="form-group">
                <div style="display:flex; gap:20px;">
                    <div style="flex:1;">
                        <label>ì´ë¯¸ì§€ ë³€ê²½</label>
                        <input type="file" accept="image/*" onchange="handleImageUpload(this, 'mainImage')">
                    </div>
                    <img id="mainImagePreview" class="preview-img" src="">
                </div>
            </div>
        </section>

        <section>
            <h2>2. ê°¤ëŸ¬ë¦¬</h2>
            <div class="form-group">
                <input type="file" accept="image/*" multiple onchange="handleGalleryUpload(this)">
            </div>
            <div id="galleryContainer" class="gallery-grid"></div>
        </section>

        <section>
            <h2>3. í•„ëª¨ê·¸ë˜í”¼</h2>
            <div id="filmoContainer"></div>
        </section>
    </div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ë²„ì „ íˆìŠ¤í† ë¦¬</h3>
                <button class="btn btn-outline" onclick="closeHistory()">ë‹«ê¸°</button>
            </div>
            <ul class="history-list" id="historyList">
                </ul>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        /* --- [ì „ì—­ ì„¤ì •] --- */
        const MAX_WIDTH = 800;
        const QUALITY = 0.7;
        const CATEGORY_ORDER = ["DRAMA", "MOVIE", "VARIETY", "COMMERCIALS (ADS)"];
        
        // GitHub ì„¤ì •ê°’ (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¶ˆëŸ¬ì˜´)
        let ghConfig = JSON.parse(localStorage.getItem('ghConfig')) || { owner: '', repo: '', token: '' };

        /* --- [ì´ˆê¸°í™”] --- */
        window.onload = function() {
            // ì„¤ì •ê°’ UIì— ì±„ìš°ê¸°
            document.getElementById('confOwner').value = ghConfig.owner;
            document.getElementById('confRepo').value = ghConfig.repo;
            document.getElementById('confToken').value = ghConfig.token;

            if(typeof portfolioData !== 'undefined') {
                initAdmin();
            } else {
                alert("data.js íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. GitHubì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ìƒˆë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.");
            }
        };

        function initAdmin() {
            document.getElementById('mainImagePreview').src = portfolioData.mainImage;
            renderGallery();
            renderFilmoGroups();
        }

        /* --- [ì„¤ì • ê´€ë ¨] --- */
        function toggleConfig() {
            document.getElementById('configPanel').classList.toggle('open');
        }
        function saveConfig() {
            const owner = document.getElementById('confOwner').value.trim();
            const repo = document.getElementById('confRepo').value.trim();
            const token = document.getElementById('confToken').value.trim();
            
            if(!owner || !repo || !token) return alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            ghConfig = { owner, repo, token };
            localStorage.setItem('ghConfig', JSON.stringify(ghConfig));
            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ 'GitHub ìë™ ì €ì¥'ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            toggleConfig();
        }

        /* --- [ì´ë¯¸ì§€ ì²˜ë¦¬ (ì••ì¶•)] --- */
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', QUALITY));
                }
            }
        }
        function handleImageUpload(input, key) {
            if (input.files[0]) compressImage(input.files[0], res => {
                portfolioData[key] = res;
                document.getElementById('mainImagePreview').src = res;
            });
        }
        function handleGalleryUpload(input) {
            Array.from(input.files).forEach(file => {
                compressImage(file, res => {
                    portfolioData.gallery.unshift(res);
                    renderGallery();
                });
            });
            input.value = '';
        }

        /* --- [UI ë Œë”ë§ (ì´ì „ê³¼ ë™ì¼)] --- */
        function renderGallery() {
            document.getElementById('galleryContainer').innerHTML = portfolioData.gallery.map((url, i) => `
                <div class="gallery-item"><img src="${url}"><button class="remove-btn" onclick="portfolioData.gallery.splice(${i},1); renderGallery();">Ã—</button></div>
            `).join('');
        }

        function renderFilmoGroups() {
            const container = document.getElementById('filmoContainer');
            container.innerHTML = '';
            const groups = {};
            CATEGORY_ORDER.forEach(cat => groups[cat] = []);
            portfolioData.filmography.forEach((item, index) => {
                item._originIndex = index;
                if (!groups[item.category]) groups[item.category] = [];
                groups[item.category].push(item);
            });

            Object.keys(groups).forEach(cat => {
                const section = document.createElement('section');
                section.className = 'category-section';
                section.innerHTML = `
                    <div class="category-header"><span class="category-title">${cat}</span></div>
                    <button class="btn-add-section" onclick="addFilmo('${cat}')">+ Add to <b>${cat}</b></button>
                    <div class="filmo-list"></div>
                `;
                const list = section.querySelector('.filmo-list');
                if(groups[cat].length === 0) list.innerHTML = `<div class="empty-message">ì‘í’ˆ ì—†ìŒ</div>`;
                else groups[cat].forEach(item => list.appendChild(createFilmoItem(item)));
                container.appendChild(section);
            });
        }

        function createFilmoItem(item) {
            const el = document.createElement('div');
            el.className = 'filmo-item';
            el.innerHTML = `
                <div class="filmo-summary" onclick="this.parentElement.classList.toggle('active')">
                    <img src="${item.thumb}" class="thumb-preview">
                    <div class="info-preview">
                        <div style="font-weight:bold">${item.title.ko || '(ì œëª©)'}</div>
                        <div style="font-size:0.8rem; color:#888">${item.year} | ${item.role.ko}</div>
                    </div>
                    <div>â–¼</div>
                </div>
                <div class="filmo-details">
                    <div style="text-align:right"><button class="btn btn-danger" onclick="deleteFilmo(${item._originIndex})">ì‚­ì œ</button></div>
                    <div class="form-group"><label>ì¸ë„¤ì¼</label><input type="file" accept="image/*" onchange="updateThumb(this, ${item._originIndex})"></div>
                    <div class="lang-grid">
                        <div class="form-group"><label>ì—°ë„</label><input type="text" value="${item.year}" onchange="portfolioData.filmography[${item._originIndex}].year=this.value"></div>
                        <div class="form-group"><label>ë°©ì†¡ì‚¬</label><input type="text" value="${item.broadcast}" onchange="portfolioData.filmography[${item._originIndex}].broadcast=this.value"></div>
                    </div>
                    <div class="form-group"><label>ì œëª© (KO)</label><input type="text" value="${item.title.ko}" onchange="portfolioData.filmography[${item._originIndex}].title.ko=this.value"></div>
                    <div class="form-group"><label>ì œëª© (EN)</label><input type="text" value="${item.title.en}" onchange="portfolioData.filmography[${item._originIndex}].title.en=this.value"></div>
                    </div>
            `;
            return el;
        }

        function addFilmo(cat) {
            portfolioData.filmography.unshift({ category: cat, year: new Date().getFullYear(), thumb: "https://placehold.co/200", broadcast:"", title:{ko:"ìƒˆ ì‘í’ˆ", en:""}, role:{ko:"", en:""} });
            renderFilmoGroups();
        }
        function deleteFilmo(i) { if(confirm('ì‚­ì œ?')) { portfolioData.filmography.splice(i, 1); renderFilmoGroups(); } }
        function updateThumb(input, i) { if(input.files[0]) compressImage(input.files[0], res => { portfolioData.filmography[i].thumb = res; renderFilmoGroups(); }); }


        /* =========================================
           â˜… í•µì‹¬: GitHub API ì—°ë™ (ìë™ ì €ì¥ ë° íˆìŠ¤í† ë¦¬)
           ========================================= */
        
        // 1. GitHubì— ì €ì¥ (Commit)
        async function saveToGitHub() {
            if(!ghConfig.owner || !ghConfig.token) return alert("ìƒë‹¨ì˜ [âš™ï¸ ì„¤ì •] ë²„íŠ¼ì„ ëˆŒëŸ¬ GitHub ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”!");
            
            document.getElementById('loadingSpinner').style.display = 'block';

            const content = "const portfolioData = " + JSON.stringify(portfolioData, null, 4) + ";";
            // í•œê¸€ ê¹¨ì§ ë°©ì§€ë¥¼ ìœ„í•œ Base64 ì¸ì½”ë”© (UTF-8)
            const contentEncoded = btoa(unescape(encodeURIComponent(content)));
            
            const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/data.js`;

            try {
                // 1. ê¸°ì¡´ íŒŒì¼ì˜ SHA ê°’ ê°€ì ¸ì˜¤ê¸° (ë®ì–´ì“°ê¸° ìœ„í•´ í•„ìš”)
                const getRes = await fetch(url, {
                    headers: { Authorization: `token ${ghConfig.token}` }
                });
                const getData = await getRes.json();
                const sha = getData.sha;

                // 2. íŒŒì¼ ì—…ë°ì´íŠ¸ (PUT)
                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        Authorization: `token ${ghConfig.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Admin Update: ${new Date().toLocaleString()}`, // ì»¤ë°‹ ë©”ì‹œì§€
                        content: contentEncoded,
                        sha: sha
                    })
                });

                if(putRes.ok) {
                    alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! \n(ì›¹ì‚¬ì´íŠ¸ ë°˜ì˜ê¹Œì§€ 1~3ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤)");
                } else {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + putRes.statusText);
                }

            } catch (err) {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + err);
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // 2. íˆìŠ¤í† ë¦¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadHistory() {
            if(!ghConfig.owner || !ghConfig.token) return alert("ì„¤ì • ë¨¼ì € í•´ì£¼ì„¸ìš”.");
            
            document.getElementById('loadingSpinner').style.display = 'block';
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/commits?path=data.js`;

            try {
                const res = await fetch(url, { headers: { Authorization: `token ${ghConfig.token}` } });
                const commits = await res.json();

                commits.forEach(commit => {
                    const date = new Date(commit.commit.author.date).toLocaleString();
                    const msg = commit.commit.message;
                    const sha = commit.sha;

                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerHTML = `
                        <div class="history-info">
                            <div>${msg}</div>
                            <span>${date}</span>
                        </div>
                        <button class="btn btn-outline" onclick="restoreVersion('${sha}')">ì´ ë²„ì „ìœ¼ë¡œ ë³µêµ¬</button>
                    `;
                    list.appendChild(li);
                });

                document.getElementById('historyModal').style.display = 'flex';

            } catch(err) {
                alert("íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨: " + err);
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // 3. íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë³µêµ¬
        async function restoreVersion(sha) {
            if(!confirm("ì •ë§ ì´ ë²„ì „ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤)")) return;

            document.getElementById('loadingSpinner').style.display = 'block';
            
            // í•´ë‹¹ ì»¤ë°‹ ì‹œì ì˜ íŒŒì¼ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/data.js?ref=${sha}`;

            try {
                const res = await fetch(url, { headers: { Authorization: `token ${ghConfig.token}` } });
                const data = await res.json();
                
                // Base64 ë””ì½”ë”© (í•œê¸€ ì²˜ë¦¬ í¬í•¨)
                const decodedContent = decodeURIComponent(escape(atob(data.content)));
                
                // eval()ì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ìì—´ì„ ì‹¤ì œ JS ê°ì²´ë¡œ ë³€í™˜ (ì£¼ì˜: portfolioData ë³€ìˆ˜ ê°±ì‹ )
                // data.js íŒŒì¼ êµ¬ì¡°ê°€ 'const portfolioData = { ... };' í˜•íƒœë¼ê³  ê°€ì •
                const cleanJson = decodedContent.replace('const portfolioData =', '').replace(';', '');
                portfolioData = JSON.parse(cleanJson);

                // í™”ë©´ ê°±ì‹ 
                initAdmin();
                closeHistory();
                alert("ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤! (ì™„ì „íˆ ì ìš©í•˜ë ¤ë©´ 'GitHub ìë™ ì €ì¥'ì„ ê¼­ ëˆŒëŸ¬ì£¼ì„¸ìš”)");

            } catch(err) {
                alert("ë³µêµ¬ ì‹¤íŒ¨: " + err);
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }
    </script>
</body>
</html>