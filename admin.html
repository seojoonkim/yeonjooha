<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Admin (Fixed Drag & Drop)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        /* --- [ê¸°ë³¸ ìŠ¤íƒ€ì¼] --- */
        body { font-family: 'Pretendard', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        
        /* í—¤ë” */
        .sticky-header { position: sticky; top: 0; background: rgba(255,255,255,0.98); z-index: 1000; padding: 15px 0; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .config-panel { background: #eef2f5; padding: 15px; border-radius: 8px; font-size: 0.9rem; display: none; margin-bottom: 15px; }
        .config-panel.open { display: block; }
        .config-row { display: flex; gap: 10px; margin-bottom: 5px; }
        
        /* ë²„íŠ¼ */
        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: #2c3e50; color: white; }
        .btn-primary:hover { background: #1a252f; }
        .btn-outline { border: 1px solid #ddd; background: white; color: #555; }
        .btn-danger { background: #ff6b6b; color: white; font-size: 0.8rem; padding: 5px 10px; }
        .btn-sync { background: #27ae60; color: white; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .btn-history { background: #f39c12; color: white; font-size: 0.9rem; }
        .btn-auto-trans { background: #fff; border: 1px solid #6c5ce7; color: #6c5ce7; padding: 4px 10px; font-size: 0.8rem; border-radius: 20px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; transition: 0.2s; }
        .btn-auto-trans:hover { background: #6c5ce7; color: white; }
        
        /* í¼ ìš”ì†Œ */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; color: #555; }
        input[type="text"], input[type="password"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem; box-sizing: border-box; }
        .preview-img { max-width: 150px; max-height: 150px; border: 1px solid #eee; margin-top: 10px; border-radius: 4px; object-fit: cover;}
        
        /* ê°¤ëŸ¬ë¦¬ */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .gallery-item { position: relative; aspect-ratio: 1/1; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .remove-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; }

        /* í•„ëª¨ê·¸ë˜í”¼ ì„¹ì…˜ */
        .category-section { margin-bottom: 30px; background: #f8f9fa; border-radius: 8px; padding: 20px; border: 1px solid #e9ecef; }
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .category-title { font-size: 1.2rem; font-weight: 800; color: #2c3e50; }
        
        .filmo-list { min-height: 50px; } /* ë“œë˜ê·¸ ì˜ì—­ í™•ë³´ */
        
        .filmo-item { background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 10px; transition: transform 0.2s, box-shadow 0.2s; }
        .filmo-item.dragging { opacity: 0.5; border: 2px dashed #2c3e50; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .filmo-summary { display: flex; align-items: center; padding: 15px; cursor: pointer; }
        .filmo-summary:hover { background: #f1f3f5; }
        .filmo-details { display: none; padding: 20px; border-top: 1px solid #eee; background: #fafafa; }
        .filmo-item.active .filmo-details { display: block; }
        
        .drag-handle { cursor: grab; padding: 10px; color: #aaa; font-size: 1.5rem; margin-right: 5px; }
        .drag-handle:active { cursor: grabbing; color: #333; }
        
        .thumb-preview { width: 40px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; background: #eee; }
        .info-preview { flex: 1; }
        
        .btn-add-section { width: 100%; padding: 12px; background-color: white; border: 2px dashed #cbd5e0; color: #4a5568; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 10px;}
        .empty-message { text-align: center; color: #888; padding: 20px; }
        .lang-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        /* íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ & ë¡œë”© */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 600px; max-height: 80vh; border-radius: 12px; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 4px solid white; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #eee; color: #555; margin-left: 10px; }
        .status-badge.active { background: #e8f5e9; color: #27ae60; border: 1px solid #27ae60; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingSpinner">
        <div class="spinner"></div>
        <div id="loadingText">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>

    <div class="container">
        <div class="sticky-header">
            <div class="header-top">
                <div style="display: flex; align-items: center;">
                    <h1>ADMIN PAGE</h1>
                    <span id="syncStatus" class="status-badge">Local Mode</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="toggleConfig()">âš™ï¸ ì„¤ì •</button>
                    <button class="btn btn-history" onclick="loadHistory()">ğŸ•’ íˆìŠ¤í† ë¦¬</button>
                    <button class="btn btn-sync" onclick="forceLoadFromGitHub()">ğŸ”„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="btn btn-primary" onclick="saveDataJsToGitHub()">â˜ï¸ ì €ì¥</button>
                </div>
            </div>
            <div id="configPanel" class="config-panel">
                <p style="margin:0 0 10px 0; font-weight:bold; color:#e74c3c;">â€» GitHub ì •ë³´ ì„¤ì •</p>
                <div class="config-row">
                    <input type="text" id="confOwner" placeholder="GitHub ì•„ì´ë””">
                    <input type="text" id="confRepo" placeholder="ë ˆí¬ì§€í† ë¦¬ ì´ë¦„">
                </div>
                <div class="config-row">
                    <input type="password" id="confToken" placeholder="GitHub Token">
                    <button class="btn btn-primary" onclick="saveConfig()">ì„¤ì • ì €ì¥</button>
                </div>
            </div>
        </div>

        <section>
            <h2>1. ë©”ì¸ í”„ë¡œí•„</h2>
            <div class="form-group">
                <div style="display:flex; gap:20px;">
                    <div style="flex:1;">
                        <label>ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
                        <input type="file" accept="image/*" onchange="uploadImage(this, 'mainImage')">
                    </div>
                    <img id="mainImagePreview" class="preview-img" src="">
                </div>
            </div>
        </section>

        <section>
            <h2>2. ê°¤ëŸ¬ë¦¬</h2>
            <div class="form-group">
                <label>ì‚¬ì§„ ì¶”ê°€ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
                <input type="file" accept="image/*" multiple onchange="uploadGalleryImages(this)">
            </div>
            <div id="galleryContainer" class="gallery-grid"></div>
        </section>

        <section>
            <h2>3. í•„ëª¨ê·¸ë˜í”¼ (ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥)</h2>
            <div id="filmoContainer"></div>
        </section>
    </div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ë²„ì „ íˆìŠ¤í† ë¦¬</h3>
                <button class="btn btn-outline" onclick="closeHistory()">ë‹«ê¸°</button>
            </div>
            <ul class="history-list" id="historyList"></ul>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        /* --- [ì„¤ì •] --- */
        const CATEGORY_ORDER = ["DRAMA", "MOVIE", "VARIETY", "AUDIOBOOK", "COMMERCIALS (ADS)"];
        const LANG_LIST = ['ko', 'en', 'cn', 'ja', 'pt', 'es', 'ar'];
        const LANG_LABEL = { ko:'í•œêµ­ì–´', en:'English', cn:'ä¸­æ–‡', ja:'æ—¥æœ¬èª', pt:'PortuguÃªs', es:'EspaÃ±ol', ar:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' };

        let ghConfig = JSON.parse(localStorage.getItem('ghConfig')) || { owner: '', repo: '', token: '' };

        window.onload = function() {
            document.getElementById('confOwner').value = ghConfig.owner;
            document.getElementById('confRepo').value = ghConfig.repo;
            document.getElementById('confToken').value = ghConfig.token;
            
            if(typeof portfolioData !== 'undefined') {
                initAdmin();
            }
            if(ghConfig.owner && ghConfig.token) forceLoadFromGitHub(true);
        };

        function initAdmin() {
            document.getElementById('mainImagePreview').src = portfolioData.mainImage;
            renderGallery();
            renderFilmoGroups();
        }
        function toggleConfig() { document.getElementById('configPanel').classList.toggle('open'); }
        function saveConfig() {
            ghConfig = { owner: document.getElementById('confOwner').value.trim(), repo: document.getElementById('confRepo').value.trim(), token: document.getElementById('confToken').value.trim() };
            localStorage.setItem('ghConfig', JSON.stringify(ghConfig));
            alert("ì„¤ì • ì €ì¥ ì™„ë£Œ!"); toggleConfig(); forceLoadFromGitHub();
        }

        /* --- [ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ (ìˆ˜ì •ë¨)] --- */
        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            // íŒŒì´ì–´í­ìŠ¤ ëŒ€ì‘
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedItem = null;
            
            // [ì¤‘ìš”] ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ í˜„ì¬ í™”ë©´ ìˆœì„œëŒ€ë¡œ ë°ì´í„° ê°±ì‹ 
            reorderDataFromDOM();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
            const list = this.closest('.filmo-list');
            if (!list) return;

            const afterElement = getDragAfterElement(list, e.clientY);
            if (afterElement == null) {
                list.appendChild(draggedItem);
            } else {
                list.insertBefore(draggedItem, afterElement);
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.filmo-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // DOM ìˆœì„œë¥¼ ê¸°ì¤€ìœ¼ë¡œ portfolioData.filmography ë°°ì—´ ì¬ì •ë ¬
        function reorderDataFromDOM() {
            const newOrder = [];
            // ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë¦¬ìŠ¤íŠ¸ì˜ ì•„ì´í…œì„ ìˆœì„œëŒ€ë¡œ ê°€ì ¸ì˜´
            document.querySelectorAll('.filmo-item').forEach(el => {
                const originIdx = el.dataset.originIndex;
                if (portfolioData.filmography[originIdx]) {
                    newOrder.push(portfolioData.filmography[originIdx]);
                }
            });
            
            // ë°ì´í„° ê°±ì‹  ë° ì¬ ë Œë”ë§ (ì¸ë±ìŠ¤ ì¬ì„¤ì • ìœ„í•´)
            portfolioData.filmography = newOrder;
            renderFilmoGroups(); 
        }


        /* --- [ë Œë”ë§] --- */
        function renderFilmoGroups() {
            const container = document.getElementById('filmoContainer');
            container.innerHTML = '';
            const groups = {};
            
            CATEGORY_ORDER.forEach(cat => groups[cat] = []);
            
            portfolioData.filmography.forEach((item, index) => {
                item._originIndex = index; // ì›ë³¸ ì¸ë±ìŠ¤ ì €ì¥
                if (!groups[item.category]) groups[item.category] = [];
                groups[item.category].push(item);
            });

            Object.keys(groups).forEach(cat => {
                const section = document.createElement('section');
                section.className = 'category-section';
                section.innerHTML = `
                    <div class="category-header">
                        <span class="category-title">${cat}</span>
                        <span style="font-size:0.8rem; color:#888;">(${groups[cat].length})</span>
                    </div>
                    <button class="btn-add-section" onclick="addFilmo('${cat}')">+ Add to <b>${cat}</b></button>
                    <div class="filmo-list"></div>
                `;
                
                const listContainer = section.querySelector('.filmo-list');
                
                // [ì¤‘ìš”] ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì»¨í…Œì´ë„ˆì— ì§ì ‘ ë“±ë¡
                listContainer.addEventListener('dragover', handleDragOver);
                
                if(groups[cat].length === 0) {
                    listContainer.innerHTML = `<div class="empty-message">ì‘í’ˆ ì—†ìŒ</div>`;
                } else {
                    groups[cat].forEach(item => {
                        listContainer.appendChild(createFilmoItem(item));
                    });
                }
                container.appendChild(section);
            });
        }

        function createFilmoItem(item) {
            const el = document.createElement('div');
            el.className = 'filmo-item';
            el.draggable = true; // ë“œë˜ê·¸ ê°€ëŠ¥ ì„¤ì •
            el.dataset.originIndex = item._originIndex;
            
            // [ì¤‘ìš”] ì•„ì´í…œë³„ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì—°ê²°
            el.addEventListener('dragstart', handleDragStart);
            el.addEventListener('dragend', handleDragEnd);

            // ë‹¤êµ­ì–´ ì…ë ¥ì°½ í—¬í¼
            const createLangInputs = (type) => LANG_LIST.map(lang => `
                <div class="lang-item">
                    <label>${LANG_LABEL[lang]} (${lang.toUpperCase()})</label>
                    <input type="text" id="input-${item._originIndex}-${type}-${lang}" value="${item[type][lang] || ''}" onchange="portfolioData.filmography[${item._originIndex}].${type}.${lang}=this.value">
                </div>
            `).join('');

            el.innerHTML = `
                <div class="filmo-summary" onclick="if(!event.target.classList.contains('drag-handle')) this.parentElement.classList.toggle('active')">
                    <div class="drag-handle">â‰¡</div>
                    <img src="${item.thumb}" class="thumb-preview">
                    <div class="info-preview">
                        <div style="font-weight:bold">${item.title.ko || '(ì œëª©)'}</div>
                        <div style="font-size:0.8rem; color:#888">${item.year} | ${item.role.ko}</div>
                    </div>
                    <div>â–¼</div>
                </div>
                <div class="filmo-details">
                    <div style="text-align:right"><button class="btn btn-danger" onclick="deleteFilmo(${item._originIndex})">ì‚­ì œ</button></div>
                    <div class="form-group" style="background:#f9f9f9; padding:10px; border-radius:6px;">
                        <label>ê¸°ë³¸ ì •ë³´</label>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <div style="flex:1"><label>ì—°ë„</label><input type="text" value="${item.year}" onchange="portfolioData.filmography[${item._originIndex}].year=this.value"></div>
                            <div style="flex:1"><label>ë°©ì†¡ì‚¬</label><input type="text" value="${item.broadcast}" onchange="portfolioData.filmography[${item._originIndex}].broadcast=this.value"></div>
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <img src="${item.thumb}" class="preview-img" style="width:60px; height:90px; margin:0;">
                            <div style="flex:1"><label>í¬ìŠ¤í„° ë³€ê²½</label><input type="file" accept="image/*" onchange="uploadImage(this, 'thumb', ${item._originIndex})"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="label-row"><label style="margin:0">ì œëª© (Title)</label><button class="btn-auto-trans" onclick="runAutoTranslate(${item._originIndex}, 'title')">âš¡ ìë™ ë²ˆì—­</button></div>
                        <div class="lang-grid">${createLangInputs('title')}</div>
                    </div>
                    <div class="form-group">
                        <div class="label-row"><label style="margin:0">ì—­í•  (Role)</label><button class="btn-auto-trans" onclick="runAutoTranslate(${item._originIndex}, 'role')">âš¡ ìë™ ë²ˆì—­</button></div>
                        <div class="lang-grid">${createLangInputs('role')}</div>
                    </div>
                </div>`;
            return el;
        }

        // --- [ê¸°íƒ€ í•¨ìˆ˜ë“¤ (ì´ì „ê³¼ ë™ì¼)] ---
        function renderGallery() { document.getElementById('galleryContainer').innerHTML = portfolioData.gallery.map((url, i) => `<div class="gallery-item"><img src="${url}"><button class="remove-btn" onclick="portfolioData.gallery.splice(${i},1); renderGallery();">Ã—</button></div>`).join(''); }
        function addFilmo(cat) { const emptyLangObj = {}; LANG_LIST.forEach(lang => emptyLangObj[lang] = ""); portfolioData.filmography.unshift({ category: cat, year: new Date().getFullYear(), thumb: "https://placehold.co/200", broadcast:"", title: { ...emptyLangObj, ko: "ìƒˆ ì‘í’ˆ" }, role: { ...emptyLangObj } }); renderFilmoGroups(); }
        function deleteFilmo(i) { if(confirm('ì‚­ì œ?')) { portfolioData.filmography.splice(i, 1); renderFilmoGroups(); } }
        
        async function forceLoadFromGitHub(silent = false) {
            if(!ghConfig.owner || !ghConfig.token) return;
            if(!silent) showLoading("GitHub ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
            const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/data.js?ref=main&timestamp=${new Date().getTime()}`;
            try {
                const res = await fetch(url, { headers: { Authorization: `token ${ghConfig.token}` } });
                if(!res.ok) throw new Error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                const json = await res.json();
                const content = decodeURIComponent(escape(window.atob(json.content)));
                const jsonStr = content.replace('const portfolioData =', '').replace(';', '');
                portfolioData = JSON.parse(jsonStr);
                initAdmin();
                const statusBadge = document.getElementById('syncStatus');
                statusBadge.textContent = "Synced with GitHub"; statusBadge.classList.add('active');
                if(!silent) alert("ë™ê¸°í™” ì™„ë£Œ!");
            } catch(err) { console.error(err); if(!silent) alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); } finally { hideLoading(); }
        }

        async function saveDataJsToGitHub() {
            if(!ghConfig.owner || !ghConfig.token) return alert("ì„¤ì • í•„ìš”"); showLoading("ë°ì´í„° ì €ì¥ ì¤‘...");
            const content = "const portfolioData = " + JSON.stringify(portfolioData, null, 4) + ";";
            const contentEncoded = btoa(unescape(encodeURIComponent(content)));
            const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/data.js`;
            try {
                const getRes = await fetch(url, { headers: { Authorization: `token ${ghConfig.token}` } });
                const getData = await getRes.json();
                const putRes = await fetch(url, { method: 'PUT', headers: { Authorization: `token ${ghConfig.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `Update data.js`, content: contentEncoded, sha: getData.sha }) });
                if(putRes.ok) alert("ì €ì¥ ì™„ë£Œ! (1~3ë¶„ í›„ ë°˜ì˜ë©ë‹ˆë‹¤)"); else alert("ì €ì¥ ì‹¤íŒ¨");
            } catch(err) { alert("ì˜¤ë¥˜: " + err); } finally { hideLoading(); }
        }
        
        /* (ìƒëµëœ ì´ë¯¸ì§€ ì—…ë¡œë“œ, ë²ˆì—­, íˆìŠ¤í† ë¦¬ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë¨) */
        async function uploadImage(input, targetKey, index = null) { if (!input.files || !input.files[0]) return; const file = input.files[0]; showLoading(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...`); try { const base64Content = await toBase64(file); const fileName = `images/${new Date().getTime()}_${file.name}`; const uploadedUrl = await uploadFileToGitHub(fileName, base64Content); if (index !== null) { portfolioData.filmography[index].thumb = uploadedUrl; renderFilmoGroups(); const itemEl = document.querySelector(`.filmo-item[data-origin-index="${index}"]`); if(itemEl) { itemEl.querySelector('.thumb-preview').src = base64Content; itemEl.querySelector('.preview-img').src = base64Content; } } else { portfolioData[targetKey] = uploadedUrl; document.getElementById('mainImagePreview').src = base64Content; } alert("ì—…ë¡œë“œ ì„±ê³µ!"); } catch (err) { alert("ì‹¤íŒ¨: " + err.message); } finally { hideLoading(); input.value = ''; } }
        async function uploadGalleryImages(input) { if (!input.files || input.files.length === 0) return; const files = Array.from(input.files); let successCount = 0; const tempPreviews = []; try { for (let i = 0; i < files.length; i++) { showLoading(`ê°¤ëŸ¬ë¦¬ ì—…ë¡œë“œ ì¤‘... (${i + 1}/${files.length})`); const file = files[i]; const base64Content = await toBase64(file); tempPreviews.push(base64Content); const fileName = `images/${new Date().getTime()}_${i}_${file.name}`; const uploadedUrl = await uploadFileToGitHub(fileName, base64Content); portfolioData.gallery.unshift(uploadedUrl); successCount++; } renderGallery(); const galleryItems = document.querySelectorAll('.gallery-item img'); for(let i=0; i < tempPreviews.length; i++) { if(galleryItems[i]) galleryItems[i].src = tempPreviews[files.length - 1 - i]; } alert(`${successCount}ì¥ ì—…ë¡œë“œ ì™„ë£Œ`); } catch (err) { alert("ì¼ë¶€ ì‹¤íŒ¨: " + err.message); } finally { hideLoading(); input.value = ''; } }
        async function uploadFileToGitHub(path, content) { if(!ghConfig.owner || !ghConfig.token) throw new Error("GitHub ì„¤ì • í•„ìš”"); const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${path}`; const cleanContent = content.split(',')[1]; const res = await fetch(url, { method: 'PUT', headers: { Authorization: `token ${ghConfig.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `Upload image: ${path}`, content: cleanContent }) }); if (!res.ok) throw new Error(res.statusText); return `https://${ghConfig.owner}.github.io/${ghConfig.repo}/${path}`; }
        function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }
        async function runAutoTranslate(index, fieldType) { const item = portfolioData.filmography[index]; const sourceText = item[fieldType].en || item[fieldType].ko; if (!sourceText) { alert("ë‚´ìš© í•„ìš”"); return; } if (!confirm("ìë™ ë²ˆì—­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; showLoading("ë²ˆì—­ ì¤‘..."); const targets = ['cn', 'ja', 'pt', 'es', 'ar']; try { for (const lang of targets) { let apiLang = lang === 'cn' ? 'zh-CN' : lang; const translated = await fetchTranslation(sourceText, apiLang); portfolioData.filmography[index][fieldType][lang] = translated; const inputEl = document.getElementById(`input-${index}-${fieldType}-${lang}`); if (inputEl) inputEl.value = translated; } alert("ì™„ë£Œ"); } catch (err) { alert("ì˜¤ë¥˜: " + err.message); } finally { hideLoading(); } }
        async function fetchTranslation(text, targetLang) { const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${targetLang}`; try { const res = await fetch(url); const data = await res.json(); return data.responseData ? data.responseData.translatedText : ""; } catch (e) { console.error(e); return ""; } }
        async function loadHistory() { if(!ghConfig.owner || !ghConfig.token) return alert("ì„¤ì • í•„ìš”"); showLoading("íˆìŠ¤í† ë¦¬ ë¡œë“œ..."); const list = document.getElementById('historyList'); list.innerHTML = ''; const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/commits?path=data.js`; try { const res = await fetch(url, { headers: { Authorization: `token ${ghConfig.token}` } }); const commits = await res.json(); commits.forEach(commit => { const date = new Date(commit.commit.author.date).toLocaleString(); const msg = commit.commit.message; const sha = commit.sha; const li = document.createElement('li'); li.className = 'history-item'; li.innerHTML = `<div class="history-info"><div>${msg}</div><span>${date}</span></div><button class="btn btn-outline" onclick="restoreVersion('${sha}')">ë³µêµ¬</button>`; list.appendChild(li); }); document.getElementById('historyModal').style.display = 'flex'; } catch(err) { alert("ì‹¤íŒ¨: " + err); } finally { hideLoading(); } }
        async function restoreVersion(sha) { if(!confirm("ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; showLoading("ë³µêµ¬ ì¤‘..."); const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/data.js?ref=${sha}`; try { const res = await fetch(url, { headers: { Authorization: `token ${ghConfig.token}` } }); const data = await res.json(); const content = decodeURIComponent(escape(window.atob(data.content))); const jsonStr = content.replace('const portfolioData =', '').replace(';', ''); portfolioData = JSON.parse(jsonStr); initAdmin(); closeHistory(); alert("ë³µêµ¬ë¨! ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì •í•˜ì„¸ìš”."); } catch(err) { alert("ì‹¤íŒ¨: " + err); } finally { hideLoading(); } }
        function closeHistory() { document.getElementById('historyModal').style.display = 'none'; }
        function showLoading(msg) { document.getElementById('loadingText').textContent = msg; document.getElementById('loadingSpinner').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; }
    </script>
</body>
</html>